{
  "files": [
    {
      "filename": "main.py",
      "content": "from fastapi import FastAPI, HTTPException, WebSocket, UploadFile, File\nfrom fastapi.middleware.cors import CORSMiddleware\nfrom pydantic import BaseModel\nfrom typing import List, Optional\nimport time\nimport uuid\nimport hashlib\nimport json\nimport jwt\n\napp = FastAPI()\n\napp.add_middleware(\n    CORSMiddleware,\n    allow_origins=[\"*\"],\n    allow_credentials=True,\n    allow_methods=[\"*\"],\n    allow_headers=[\"*\"],\n)\n\nSECRET_KEY = \"chat-secret-key\"\nusers_db = {}\nrooms_db = {}\nmessages_db = []\nactive_connections = []\nunread_counts = {}\n\nclass UserRegister(BaseModel):\n    username: str\n    email: str\n    password: str\n\nclass UserLogin(BaseModel):\n    username: str\n    password: str\n\nclass ChatRoomCreate(BaseModel):\n    name: str\n\ndef hash_password(password: str) -> str:\n    return hashlib.sha256(password.encode()).hexdigest()\n\ndef create_jwt(username: str) -> str:\n    return jwt.encode({\"sub\": username, \"exp\": time.time() + 3600}, SECRET_KEY, algorithm=\"HS256\")\n\n@app.websocket(\"/ws/{username}\")\nasync def websocket_endpoint(websocket: WebSocket, username: str):\n    await websocket.accept()\n    active_connections.append({\"username\": username, \"websocket\": websocket})\n    users_db[username][\"status\"] = \"online\"\n    try:\n        while True:\n            data = await websocket.receive_text()\n            msg_data = json.loads(data)\n            if msg_data.get(\"type\") == \"typing\":\n                for conn in active_connections:\n                    if conn[\"username\"] != username:\n                        await conn[\"websocket\"].send_text(json.dumps({\"type\": \"typing\", \"user\": username}))\n            elif msg_data.get(\"type\") == \"message\":\n                room_id = msg_data[\"room_id\"]\n                msg = {\"id\": len(messages_db), \"room_id\": room_id, \"user_id\": username, \"content\": msg_data[\"content\"], \"created_at\": time.time()}\n                messages_db.append(msg)\n                for conn in active_connections:\n                    if conn[\"username\"] != username:\n                        unread_counts[(conn[\"username\"], room_id)] = unread_counts.get((conn[\"username\"], room_id), 0) + 1\n                    await conn[\"websocket\"].send_text(json.dumps({\"type\": \"new_message\", \"message\": msg}))\n    except:\n        pass\n    finally:\n        active_connections[:] = [c for c in active_connections if c[\"username\"] != username]\n        users_db[username][\"status\"] = \"offline\"\n\n@app.post(\"/api/auth/register\")\ndef register(user: UserRegister):\n    if user.username in users_db:\n        raise HTTPException(status_code=400, detail=\"Username exists\")\n    users_db[user.username] = {\"email\": user.email, \"password_hash\": hash_password(user.password), \"status\": \"offline\"}\n    return {\"message\": \"User registered\"}\n\n@app.post(\"/api/auth/login\")\ndef login(user: UserLogin):\n    if user.username not in users_db:\n        raise HTTPException(status_code=401, detail=\"Invalid credentials\")\n    if hash_password(user.password) != users_db[user.username][\"password_hash\"]:\n        raise HTTPException(status_code=401, detail=\"Invalid credentials\")\n    users_db[user.username][\"status\"] = \"online\"\n    token = create_jwt(user.username)\n    return {\"message\": \"Login successful\", \"token\": token, \"user\": user.username}\n\n@app.post(\"/api/rooms\")\ndef create_room(room: ChatRoomCreate):\n    room_id = str(uuid.uuid4())\n    rooms_db[room_id] = {\"name\": room.name, \"created_at\": time.time()}\n    return {\"room_id\": room_id, \"message\": \"Room created\"}\n\n@app.get(\"/api/rooms\")\ndef list_rooms():\n    return [{\"id\": k, **v} for k, v in rooms_db.items()]\n\n@app.post(\"/api/rooms/{room_id}/join\")\ndef join_room(room_id: str):\n    if room_id not in rooms_db:\n        raise HTTPException(status_code=404, detail=\"Room not found\")\n    return {\"message\": f\"Joined room {room_id}\"}\n\n@app.get(\"/api/rooms/{room_id}/messages\")\ndef get_messages(room_id: str):\n    if room_id not in rooms_db:\n        raise HTTPException(status_code=404, detail=\"Room not found\")\n    room_msgs = [m for m in messages_db if m[\"room_id\"] == room_id]\n    return room_msgs\n\n@app.post(\"/api/upload\")\nasync def upload_file(file: UploadFile = File(...)):\n    await file.read()\n    file_url = f\"/uploads/{uuid.uuid4()}_{file.filename}\"\n    return {\"file_url\": file_url, \"message\": \"File uploaded\"}\n\n@app.get(\"/api/users/status\")\ndef get_user_status():\n    return [{\"username\": k, \"status\": v[\"status\"]} for k, v in users_db.items()]",
      "description": "Main FastAPI app with JWT auth, WebSocket for real-time messaging, file upload, and all required endpoints"
    }
  ],
  "setup_instructions": "pip install fastapi uvicorn pyjwt && uvicorn main:app --reload"
}