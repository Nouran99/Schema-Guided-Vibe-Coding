{
  "files": [
    {
      "filename": "main.py",
      "content": "from fastapi import FastAPI, HTTPException\nfrom fastapi.middleware.cors import CORSMiddleware\nfrom pydantic import BaseModel\nfrom typing import Optional, List\nfrom datetime import datetime\n\napp = FastAPI()\n\napp.add_middleware(\n    CORSMiddleware,\n    allow_origins=[\"*\"],\n    allow_credentials=True,\n    allow_methods=[\"*\"],\n    allow_headers=[\"*\"],\n)\n\nproducts_db = {}\nsuppliers_db = {}\nstock_movements_db = {}\n\nclass Product(BaseModel):\n    name: str\n    description: str = \"\"\n    unit_price: float\n    low_stock_threshold: int = 10\n    primary_supplier_id: Optional[int] = None\n\nclass Supplier(BaseModel):\n    name: str\n    contact_info: str = \"\"\n\nclass StockMovement(BaseModel):\n    product_id: int\n    movement_type: str\n    quantity: int\n    supplier_id: Optional[int] = None\n    notes: str = \"\"\n\ndef calculate_stock(product_id: int) -> int:\n    movements = [m for m in stock_movements_db.values() if m[\"product_id\"] == product_id]\n    stock = 0\n    for m in movements:\n        if m[\"movement_type\"] == \"purchase\":\n            stock += m[\"quantity\"]\n        else:\n            stock -= m[\"quantity\"]\n    return stock\n\ndef check_low_stock(product_id: int) -> bool:\n    if product_id not in products_db:\n        return False\n    stock = calculate_stock(product_id)\n    threshold = products_db[product_id][\"low_stock_threshold\"]\n    return stock <= threshold\n\n@app.get(\"/api/products\")\ndef get_products(name: Optional[str] = None, supplier_id: Optional[int] = None, low_stock: Optional[bool] = None):\n    products = list(products_db.values())\n    for p in products:\n        p[\"current_stock\"] = calculate_stock(p[\"id\"])\n        p[\"low_stock_alert\"] = check_low_stock(p[\"id\"])\n    if name:\n        products = [p for p in products if name.lower() in p[\"name\"].lower()]\n    if supplier_id:\n        products = [p for p in products if p[\"primary_supplier_id\"] == supplier_id]\n    if low_stock is not None:\n        products = [p for p in products if p[\"low_stock_alert\"] == low_stock]\n    return products\n\n@app.get(\"/api/products/{product_id}/stock\")\ndef get_product_stock(product_id: int):\n    if product_id not in products_db:\n        raise HTTPException(status_code=404, detail=\"Product not found\")\n    stock = calculate_stock(product_id)\n    is_low = check_low_stock(product_id)\n    return {\"product_id\": product_id, \"current_stock\": stock, \"low_stock_alert\": is_low}\n\n@app.post(\"/api/products\")\ndef create_product(product: Product):\n    product_id = len(products_db) + 1\n    now = datetime.now().isoformat()\n    product_data = {\n        \"id\": product_id,\n        **product.dict(),\n        \"created_at\": now,\n        \"updated_at\": now\n    }\n    products_db[product_id] = product_data\n    return product_data\n\n@app.put(\"/api/products/{product_id}\")\ndef update_product(product_id: int, product: Product):\n    if product_id not in products_db:\n        raise HTTPException(status_code=404, detail=\"Product not found\")\n    now = datetime.now().isoformat()\n    products_db[product_id].update({\n        **product.dict(),\n        \"updated_at\": now\n    })\n    return products_db[product_id]\n\n@app.delete(\"/api/products/{product_id}\")\ndef delete_product(product_id: int):\n    if product_id not in products_db:\n        raise HTTPException(status_code=404, detail=\"Product not found\")\n    del products_db[product_id]\n    return {\"message\": \"Product deleted\"}\n\n@app.get(\"/api/suppliers\")\ndef get_suppliers():\n    return list(suppliers_db.values())\n\n@app.post(\"/api/suppliers\")\ndef create_supplier(supplier: Supplier):\n    supplier_id = len(suppliers_db) + 1\n    now = datetime.now().isoformat()\n    supplier_data = {\n        \"id\": supplier_id,\n        **supplier.dict(),\n        \"created_at\": now\n    }\n    suppliers_db[supplier_id] = supplier_data\n    return supplier_data\n\n@app.get(\"/api/stock_movements\")\ndef get_stock_movements(product_id: Optional[int] = None):\n    movements = list(stock_movements_db.values())\n    if product_id:\n        movements = [m for m in movements if m[\"product_id\"] == product_id]\n    return movements\n\n@app.post(\"/api/stock_movements\")\ndef create_stock_movement(movement: StockMovement):\n    if movement.product_id not in products_db:\n        raise HTTPException(status_code=404, detail=\"Product not found\")\n    if movement.supplier_id and movement.supplier_id not in suppliers_db:\n        raise HTTPException(status_code=404, detail=\"Supplier not found\")\n    if movement.quantity <= 0:\n        raise HTTPException(status_code=400, detail=\"Quantity must be positive\")\n    movement_id = len(stock_movements_db) + 1\n    now = datetime.now().isoformat()\n    movement_data = {\n        \"id\": movement_id,\n        **movement.dict(),\n        \"created_at\": now\n    }\n    stock_movements_db[movement_id] = movement_data\n    \n    is_low = check_low_stock(movement.product_id)\n    if is_low:\n        movement_data[\"low_stock_alert\"] = True\n    \n    return movement_data\n\n@app.get(\"/api/inventory_valuation\")\ndef get_inventory_valuation():\n    valuation = 0.0\n    for product in products_db.values():\n        stock = calculate_stock(product[\"id\"])\n        valuation += stock * product[\"unit_price\"]\n    return {\"total_valuation\": valuation}",
      "description": "Main FastAPI app with CORS, in-memory storage, and core endpoints including low_stock filter and input validation"
    }
  ],
  "setup_instructions": "pip install fastapi uvicorn && uvicorn main:app --reload"
}