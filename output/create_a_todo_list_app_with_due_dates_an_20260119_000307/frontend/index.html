<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo List</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 20px auto; padding: 0 20px; }
        h1 { color: #333; }
        form { margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px; }
        input, select, button { padding: 10px; font-size: 16px; }
        button { background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        ul { list-style: none; padding: 0; }
        li { padding: 10px; border: 1px solid #ddd; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .complete { text-decoration: line-through; color: #888; }
        .priority-high { border-left: 5px solid #dc3545; }
        .priority-medium { border-left: 5px solid #ffc107; }
        .priority-low { border-left: 5px solid #28a745; }
        .filters { margin-bottom: 20px; display: flex; gap: 10px; }
        .error { color: red; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>Todo List</h1>
    <div id="error" class="error"></div>
    <form id="taskForm">
        <input type="text" id="title" placeholder="Task title" required>
        <input type="date" id="dueDate" required>
        <select id="priority" required>
            <option value="high">High</option>
            <option value="medium" selected>Medium</option>
            <option value="low">Low</option>
        </select>
        <button type="submit">Add Task</button>
    </form>
    <div class="filters">
        <select id="filterPriority">
            <option value="">All Priorities</option>
            <option value="high">High</option>
            <option value="medium">Medium</option>
            <option value="low">Low</option>
        </select>
        <button id="sortDate">Sort by Due Date</button>
    </div>
    <ul id="taskList"></ul>
    <script>
        const API_URL = 'http://localhost:8000/api/tasks';
        let tasks = [];
        let sortByDate = false;

        async function fetchTasks() {
            try {
                const filter = document.getElementById('filterPriority').value;
                let url = API_URL;
                if (filter) url += `?priority=${filter}`;
                if (sortByDate) url += (filter ? '&' : '?') + 'sort=due_date';
                const res = await fetch(url);
                if (!res.ok) throw new Error('Failed to fetch tasks');
                tasks = await res.json();
                renderTasks();
                document.getElementById('error').textContent = '';
            } catch (err) {
                document.getElementById('error').textContent = 'Error: ' + err.message;
            }
        }

        function renderTasks() {
            const list = document.getElementById('taskList');
            list.innerHTML = '';
            tasks.forEach(task => {
                const li = document.createElement('li');
                li.className = `priority-${task.priority} ${task.is_complete ? 'complete' : ''}`;
                li.innerHTML = `
                    <span>${task.title} (Due: ${task.due_date}) - ${task.priority}</span>
                    <div>
                        <button onclick="toggleComplete('${task.id}')">${task.is_complete ? 'Undo' : 'Complete'}</button>
                        <button onclick="deleteTask('${task.id}')">Delete</button>
                    </div>
                `;
                list.appendChild(li);
            });
        }

        async function addTask(event) {
            event.preventDefault();
            try {
                const title = document.getElementById('title').value;
                const dueDate = document.getElementById('dueDate').value;
                const priority = document.getElementById('priority').value;
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, due_date: dueDate, priority })
                });
                if (!res.ok) throw new Error('Failed to add task');
                document.getElementById('taskForm').reset();
                fetchTasks();
            } catch (err) {
                document.getElementById('error').textContent = 'Error: ' + err.message;
            }
        }

        async function toggleComplete(id) {
            try {
                const res = await fetch(`${API_URL}/${id}/complete`, { method: 'PATCH' });
                if (!res.ok) throw new Error('Failed to update task');
                fetchTasks();
            } catch (err) {
                document.getElementById('error').textContent = 'Error: ' + err.message;
            }
        }

        async function deleteTask(id) {
            try {
                const res = await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
                if (!res.ok) throw new Error('Failed to delete task');
                fetchTasks();
            } catch (err) {
                document.getElementById('error').textContent = 'Error: ' + err.message;
            }
        }

        document.getElementById('taskForm').addEventListener('submit', addTask);
        document.getElementById('filterPriority').addEventListener('change', fetchTasks);
        document.getElementById('sortDate').addEventListener('click', () => {
            sortByDate = !sortByDate;
            fetchTasks();
        });

        fetchTasks();
    </script>
</body>
</html>