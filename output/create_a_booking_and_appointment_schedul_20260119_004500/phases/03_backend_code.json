{
  "files": [
    {
      "filename": "main.py",
      "content": "from fastapi import FastAPI, HTTPException\nfrom fastapi.middleware.cors import CORSMiddleware\nfrom datetime import datetime\nfrom typing import List, Optional\nfrom pydantic import BaseModel\n\napp = FastAPI()\n\napp.add_middleware(\n    CORSMiddleware,\n    allow_origins=[\"*\"],\n    allow_methods=[\"*\"],\n    allow_headers=[\"*\"],\n)\n\n# In-memory storage\nservices_db = {}\navailability_db = {}\ncustomers_db = {}\nappointments_db = {}\ncounter = {\"service\": 1, \"availability\": 1, \"customer\": 1, \"appointment\": 1}\n\n# Models\nclass Service(BaseModel):\n    name: str\n    duration_minutes: int\n    description: str = \"\"\n\nclass AvailabilitySlot(BaseModel):\n    start_time: datetime\n    end_time: datetime\n    service_id: int\n\nclass Customer(BaseModel):\n    name: str\n    email: str\n    phone: str = \"\"\n\nclass Appointment(BaseModel):\n    customer_id: int\n    service_id: int\n    slot_id: int\n    status: str = \"booked\"\n\nclass AppointmentUpdate(BaseModel):\n    status: Optional[str] = None\n    slot_id: Optional[int] = None\n\n# Endpoints\n@app.get(\"/api/services\")\ndef get_services() -> List[dict]:\n    return list(services_db.values())\n\n@app.post(\"/api/services\")\ndef create_service(service: Service) -> dict:\n    service_id = counter[\"service\"]\n    service_dict = {\"id\": service_id, **service.dict()}\n    services_db[service_id] = service_dict\n    counter[\"service\"] += 1\n    return service_dict\n\n@app.post(\"/api/availability\")\ndef create_availability(slot: AvailabilitySlot) -> dict:\n    if slot.service_id not in services_db:\n        raise HTTPException(status_code=404, detail=\"Service not found\")\n    service_duration = services_db[slot.service_id][\"duration_minutes\"]\n    slot_duration = (slot.end_time - slot.start_time).seconds // 60\n    if slot_duration != service_duration:\n        raise HTTPException(status_code=400, detail=f\"Slot duration must be {service_duration} minutes\")\n    slot_id = counter[\"availability\"]\n    slot_dict = {\"id\": slot_id, **slot.dict()}\n    availability_db[slot_id] = slot_dict\n    counter[\"availability\"] += 1\n    return slot_dict\n\n@app.get(\"/api/availability\")\ndef get_availability(service_id: Optional[int] = None) -> List[dict]:\n    booked_slots = [a[\"slot_id\"] for a in appointments_db.values() if a[\"status\"] == \"booked\"]\n    available = [slot for slot in availability_db.values() if slot[\"id\"] not in booked_slots]\n    if service_id:\n        available = [slot for slot in available if slot[\"service_id\"] == service_id]\n    return available\n\n@app.post(\"/api/customers\")\ndef create_customer(customer: Customer) -> dict:\n    for cust in customers_db.values():\n        if cust[\"email\"] == customer.email:\n            return cust\n    customer_id = counter[\"customer\"]\n    customer_dict = {\"id\": customer_id, **customer.dict()}\n    customers_db[customer_id] = customer_dict\n    counter[\"customer\"] += 1\n    return customer_dict\n\n@app.post(\"/api/appointments\")\ndef create_appointment(appointment: Appointment) -> dict:\n    if appointment.slot_id not in availability_db:\n        raise HTTPException(status_code=404, detail=\"Slot not found\")\n    for appt in appointments_db.values():\n        if appt[\"slot_id\"] == appointment.slot_id and appt[\"status\"] == \"booked\":\n            raise HTTPException(status_code=400, detail=\"Slot already booked\")\n    appointment_id = counter[\"appointment\"]\n    appointment_dict = {\"id\": appointment_id, \"created_at\": datetime.now(), **appointment.dict()}\n    appointments_db[appointment_id] = appointment_dict\n    # Booking confirmation (US009)\n    if appointment.customer_id in customers_db:\n        customer_email = customers_db[appointment.customer_id][\"email\"]\n        print(f\"[EMAIL] Booking confirmation sent to {customer_email} for appointment {appointment_id}\")\n    counter[\"appointment\"] += 1\n    return appointment_dict\n\n@app.get(\"/api/appointments\")\ndef get_appointments() -> List[dict]:\n    # Email reminders (US007)\n    for appt in appointments_db.values():\n        if appt[\"status\"] == \"booked\":\n            slot = availability_db.get(appt[\"slot_id\"])\n            if slot:\n                time_until = (slot[\"start_time\"] - datetime.now()).total_seconds() / 3600\n                if 24 <= time_until <= 48:\n                    customer = customers_db.get(appt[\"customer_id\"])\n                    if customer:\n                        print(f\"[REMINDER] 24h reminder sent to {customer['email']} for appointment {appt['id']}\")\n    return list(appointments_db.values())\n\n@app.put(\"/api/appointments/{appointment_id}\")\ndef update_appointment(appointment_id: int, update: AppointmentUpdate) -> dict:\n    if appointment_id not in appointments_db:\n        raise HTTPException(status_code=404, detail=\"Appointment not found\")\n    if update.slot_id:\n        if update.slot_id not in availability_db:\n            raise HTTPException(status_code=404, detail=\"New slot not found\")\n        for appt in appointments_db.values():\n            if appt[\"slot_id\"] == update.slot_id and appt[\"status\"] == \"booked\" and appt[\"id\"] != appointment_id:\n                raise HTTPException(status_code=400, detail=\"New slot already booked\")\n    if update.status:\n        appointments_db[appointment_id][\"status\"] = update.status\n    if update.slot_id:\n        appointments_db[appointment_id][\"slot_id\"] = update.slot_id\n    return appointments_db[appointment_id]\n",
      "description": "Main FastAPI app with CORS, in-memory storage, and core endpoints for booking system"
    }
  ],
  "setup_instructions": "pip install fastapi uvicorn && uvicorn main:app --reload"
}